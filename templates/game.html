<html>
  <head>
    <!--<script src="/static/js/processing.js"></script>-->
    <script src="/static/js/jquery.js"></script>
    <!--<script src="/static/js/socket.io.js"></script>-->
    <script type="text/javascript">
      var canvas;
      var ctx;

      var pmouseX=null;
      var pmouseY=null;

      var ll=0;
      var rr=1000;
      var tt=0;
      var bb=1000;

      var patha;
      var pathb;

      function dist(x1,y1,x2,y2) {
        return Math.sqrt( Math.pow(x1-x2,2)+Math.pow(y1-y2,2) );
      }
      function mag(x,y){
        return Math.sqrt( Math.pow(x,2)+Math.pow(y,2) );
      }

      function Path(ctx){
        this.ctx = ctx;
        this.pts = [];
        this.draw = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[0][0], this.pts[0][1] );
          for(var i=1; i<this.pts.length; i++) {
            this.ctx.lineTo( this.pts[i][0], this.pts[i][1] );
          }
          this.ctx.stroke();
        }
        this.drawLast = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[this.pts.length-2][0], this.pts[this.pts.length-2][1] );
          this.ctx.lineTo( this.pts[this.pts.length-1][0], this.pts[this.pts.length-1][1] );
          this.ctx.stroke();
        }

      }

      $(document).ready( function() {

        function apply_transform(){
          ctx.setTransform(1,0,0,1,0,0);

          var xscale = canvas.width/(rr-ll);
          var yscale = canvas.height/(bb-tt);

          ctx.translate( -ll*xscale, -tt*yscale );
          ctx.scale(xscale,yscale);
        }

        function handle(delta, x, y) {

          var scalefactor = Math.pow(1.1,-delta);

          var newwidth = (rr-ll)*scalefactor;
          var newheight = (bb-tt)*scalefactor;

          var smidgex = x/canvas.width;
          var smidgey = y/canvas.height;

          var centerx = (rr-ll)*smidgex + ll;
          var centery = (bb-tt)*smidgey + tt;

          ll = centerx - newwidth*(smidgex);
          rr = centerx + newwidth*(1-smidgex);
          tt = centery - newheight*(smidgey);
          bb = centery + newheight*(1-smidgey);

          apply_transform();

          redraw();
        }

        function wheel(event){
          
          if( event.target!=canvas )
            return true;

          var delta = 0;
          if (!event)  // For IE. 
            event = window.event;
          if (event.wheelDelta) { // IE/Opera. 
            delta = event.wheelDelta/120;
          } else if (event.detail) { // Mozilla case. 
          // In Mozilla, sign of delta is different than in IE.
          // Also, delta is multiple of 3.
            delta = -event.detail/3;
          }
          // If delta is nonzero, handle it.
          // Basically, delta is now positive if wheel was scrolled up,
          // and negative, if wheel was scrolled down.
          
          if (delta)
            handle(delta, mouseX(event), mouseY(event));
          // Prevent default actions caused by mouse wheel.
          // That might be ugly, but we handle scrolls somehow
          // anyway, so don't bother here..
         
          if (event.preventDefault)
            event.preventDefault();
          event.returnValue = false;
        }

        canvas = $("#canvas")[0]
        ctx = canvas.getContext("2d");
       
        patha = new Path(ctx);
        patha.pts=[[ll,bb],[rr,tt]];
        pathb = new Path(ctx);
        pathb.pts=[[ll,tt],[rr,bb]];

        canvas.onmousedown = function(ev) {
          if(ev.button==0){
            //once through to deliver commands
            var commanded=false;

            if(!commanded){
            }

            redraw();
          }
        }
        
        canvas.onmouseup = function(ev) {
        }

        document.onkeypress = function(ev) {

          var key = String.fromCharCode( ev.charCode );
          
          if(key==='.') {

            apply_transform();
            redraw();

          }

        }
        
        canvas.oncontextmenu = function(ev) {
          return false;
        }

        canvas.onclick = function(ev) {
        }

        function mouseX(ev) {
          var posx = 0;
          if (ev.pageX) {
            posx = ev.pageX;
          }
          else if (ev.clientX) {
            posx = ev.clientX + document.body.scrollLeft
                   + document.documentElement.scrollLeft;
          }

          return posx - ev.target.offsetLeft;
        }
        function mouseY(ev) {
          var posy = 0;
          if (ev.pageY) {
            posy = ev.pageY;
          }
          else if (ev.clientY) {
            posy = ev.clientY + document.body.scrollTop
                   + document.documentElement.scrollTop;
          }

          return posy - ev.target.offsetTop;
        }

        function mapX(x) {
          return (x/canvas.width)*(rr-ll)+ll;
        }

        function mapY(y) {
          return (y/canvas.height)*(bb-tt)+tt;
        }
        
        function redraw() {
          ctx.clearRect( ll,tt,(rr-ll),(bb-tt) );
          patha.draw();
          pathb.draw();
        }


        canvas.onmousemove = function(ev){
          if( ev.button==2 ) {
            var deltax = mapX(mouseX(ev))-mapX(pmouseX);
            var deltay = mapY(mouseY(ev))-mapY(pmouseY);
            ll -= deltax;
            rr -= deltax;
            bb -= deltay;
            tt -= deltay;

            apply_transform();
            redraw();
          }


          pmouseX=mouseX(ev);
          pmouseY=mouseY(ev);
        }

        canvas.onmouseout = function(ev) {
        }

        if (window.addEventListener)
          // DOMMouseScroll is for mozilla.
          window.addEventListener('DOMMouseScroll', wheel, false);
        // IE/Opera.
        window.onmousewheel = document.onmousewheel = wheel;

      });
    </script>
  </head>
  <body style="background-color:#ffeeee">
    <canvas style="float:left;background-color:#ffffff;image-rendering:optimizeSpeed" id="canvas" width="1000" height="1000"></canvas>
    <div style="float:left;cursor:default" id="commands">
      <!--<div style="width:100;height:50;background-color:yellow;" id="commandgo">(g)o</div>
      <div style="width:100;height:50;background-color:#ff00ff;" id="commandroute">(r)oute</div>
      <div style="width:100;height:50;background-color:#00ff00;" id="commandstop">(s)top</div>-->
    <div>
  </body>
</html>
